!doctype html>
<html lang="en" ng-app="myApp">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Sync – Home Services, Done Right</title>
  <meta name="description" content="Service Sync connects you with vetted pros for home services like cleaning, lawn care, plumbing, and appliance repair with instant booking and transparent pricing." />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- Square Web Payments SDK -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body ng-controller="servicecontroller">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg fixed-top shadow-sm" style="z-index: 1050;">
    <div class="container" >
      <a class="navbar-brand d-flex align-items-center gap-2" href="#/">
        <img src="assets/img/ss_logo.png" alt="Service Sync logo" />
        <span class="fw-semibold">Service Sync</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 d-flex align-items-center gap-3">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle fs-4"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="#" ng-click="viewProfile()">View Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" ng-click="signOut()">Sign Out</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link position-relative" href="#/cart">
              <i class="bi bi-cart fs-4"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" ng-if="cartItemCount > 0">{{cartItemCount}}</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container mt-5" ng-init="">
  <form novalidate ng-submit="submitOrder()">
    <div class="row g-4">
      <!-- Left column -->
      <div class="col-lg-8">
        <!-- Order details -->
        <div class="ss-card card mb-4">
          <div class="card-header fw-semibold">Order Details</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" ng-model="orderDate" required>
                
              </div>
              <div class="col-md-6">
                <label for="time" class="form-label">Time</label>
                <input type="time" class="form-control" id="time" ng-model="orderTime" required>
              </div>
              <div class="col-12">
                <label for="notes" class="form-label">Notes</label>
                <textarea id="notes" class="form-control" ng-model="orderNotes" placeholder="Any special instructions?"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal details -->
        <div class="ss-card card mb-4">
          <div class="card-header fw-semibold">Personal Details</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" ng-model="cust.name" placeholder="Full name" required>
              </div>
              <div class="col-md-4">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" ng-model="cust.email" placeholder="name@example.com" required>
              </div>
              <div class="col-md-4">
                <label for="phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="phone" ng-model="cust.phone" placeholder="(000) 000-0000" required>
              </div>

              <div class="col-12">
                <label for="street" class="form-label">Street</label>
                <input type="text" class="form-control" id="street" ng-model="cust.street" placeholder="123 Main St" required>
              </div>

              <div class="col-md-3">
                <label for="suite" class="form-label">Suite</label>
                <input type="text" class="form-control" id="suite" ng-model="cust.suite" placeholder="Apt / Suite">
              </div>
              <div class="col-md-3">
                <label for="city" class="form-label">City</label>
                <input type="text" class="form-control" id="city" ng-model="cust.city" required>
              </div>
              <div class="col-md-2">
                <label for="state" class="form-label">State</label>
                <input type="text" class="form-control" id="state" ng-model="cust.state" maxlength="2" placeholder="PA" required>
              </div>
              <div class="col-md-4">
                <label for="zip" class="form-label">Zip</label>
                <input type="text" class="form-control" id="zip" ng-model="cust.zip" inputmode="numeric" maxlength="10" required>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment -->
        <div class="ss-card card mb-4">
          <div class="card-header fw-semibold">Payment Details</div>
          <div class="card-body">
            <div id="card-container"></div>
            <div class="alert alert-info mt-3 mb-0 text-12">
              Secure payment powered by Square.
            </div>
          </div>
        </div>

        <div class="text-end mb-4">
          <button type="submit" class="btn btn-primary btn-lg">
            Submit Payment
          </button>
        </div>
      </div>

      <!-- Right column: Summary -->
      <div class="col-lg-4">
        <div class="ss-card card ss-summary">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>Order Summary</span>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
              <div class="list-group-item" ng-if="selectedService">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="me-2">
                    <div class="fw-semibold">{{ selectedService.serviceName }}</div>
                    <div class="text-muted text-12">{{ selectedService.description }}</div>
                  </div>
                  <div class="text-end">
                    <div class="fw-semibold">{{ selectedService.price | currency }}</div>
                  </div>
                </div>
              </div>

              <div class="list-group-item d-flex justify-content-between fw-semibold">
                <span>Total</span>
                <span>{{ total | currency }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /row -->
  </form>
</div>


  <footer class="py-5 mt-4">
    <div class="container">
      <div class="row g-4">
        <div class="col-md-6">
          <div class="d-flex align-items-center gap-2 mb-2">
            <img src="assets/img/ss_logo.png" alt="Service Sync logo" style="height:28px" />
            <span class="fw-semibold text-white">Service Sync</span>
          </div>
          <p class="small mb-0">Trusted home services with transparent pricing and instant booking.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="small">© <span id="year"></span> Service Sync. All rights reserved.</div>
          <div class="small"><a href="#">Terms</a> · <a href="#">Privacy</a></div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init({ once: true, duration: 700, offset: 120 });
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- Square Payment Initialization -->
  <script>
    let card;
    async function initializeCard(payments) {
      const card = await payments.card();
      await card.attach('#card-container');
      return card;
    }

    async function createPayment(token) {
      const body = JSON.stringify({
        sourceId: token,
        amount: Math.round(window.total * 100), // Convert to cents
        currency: 'USD'
      });

      const paymentResponse = await fetch('/api/payment/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body,
      });
      return paymentResponse.json();
    }

    async function tokenize(paymentMethod) {
      const tokenResult = await paymentMethod.tokenize();
      if (tokenResult.status === 'OK') {
        return tokenResult.token;
      } else {
        let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
        if (tokenResult.errors) {
          errorMessage += ` and errors: ${JSON.stringify(tokenResult.errors)}`;
        }
        throw new Error(errorMessage);
      }
    }

    // Initialize Square payments
    document.addEventListener('DOMContentLoaded', async function () {
      if (!window.Square) {
        throw new Error('Square.js failed to load properly');
      }

      const payments = window.Square.payments('sandbox-sq0idb-_43p4hl5eUv3xkYp6FqLZA', 'sandbox');
      card = await initializeCard(payments);
    });

    // Function to handle payment and order submission
    async function handlePaymentAndOrder() {
      if (!card) {
        alert('Payment method not initialized');
        return;
      }

      try {
        const token = await tokenize(card);
        const paymentResults = await createPayment(token);
        alert('Payment successful! Payment ID: ' + paymentResults.paymentId);
        // Proceed with order submission
        // This will be called from Angular
        return true;
      } catch (e) {
        console.error(e);
        alert('Payment failed: ' + e.message);
        return false;
      }
    }
  </script>
</body>
</html>
